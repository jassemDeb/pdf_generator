<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @report_data[:title] || "Threat Intelligence Report" %></title>
</head>
<body style="font-family: 'Orbitron', Arial, sans-serif; margin: 0; padding: 0; color: #ffffff;">
  <div style="max-width: 700px; margin: auto; padding: 40px; ">

    <!-- Logo -->
    <div style=" border-radius: 50%; width: 160px; height: 160px; margin: 0 auto 30px;">
      <table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td align="center" valign="middle">
            <a href="https://www.pwnandpatch.com" target="_blank">
               <img src="<%= root_url %>assets/oktoboot-red-logo.png" alt="Oktoboot Logo" style="width: 170px; display: block;">
            </a>
          </td>
        </tr>
      </table>
    </div>

    <!-- Title & Domain -->
    <h1 style="font-size: 26px; color: #121e2b; font-weight: 700; margin-bottom: 10px;text-align: center;">
      Threat Intelligence Report
    </h1>

    <p style="font-size: 18px; color: #4b566b; margin-bottom: 30px;text-align: center;">
      <strong><%= @report_data.dig(:executive_summary, :targets_scope) || "Unspecified Domain" %></strong>
    </p>

    <!-- Metadata -->
    <p style="font-size: 14px; color: #4b566b; margin-top: 20px;text-align: center;">
      <strong>Created At:</strong> <%= @report_data[:created_at]&.to_s || "N/A" %><br>
      <strong>Updated At:</strong> <%= @report_data[:updated_at]&.to_s || "N/A" %>
    </p>

    <!-- Report Metadata -->
    <div style="page-break-before: always;"></div>
    <div style="margin: 40px auto 20px auto; padding: 20px; border-radius: 8px;text-align: center;">
      <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 10px;">Report Metadata</h3>
      <table style="width: 100%; font-size: 14px; color: #4b566b;">
        <tr>
          <td style="padding: 6px 0;"><strong>Version:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :report_version) || "N/A" %></td>
        </tr>
        <tr>
          <td style="padding: 6px 0;"><strong>Generated By:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :generated_by) || "N/A" %></td>
        </tr>
        <tr>
          <td style="padding: 6px 0;"><strong>Generated At:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :generated_at) || "N/A" %></td>
        </tr>
      </table>
    </div>

    <!-- Executive Summary: Visual Highlights -->
    <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
      <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center;">Executive Summary</h3>

      <% overview = @report_data.dig(:executive_summary, :overview) %>
      <% targets = @report_data.dig(:executive_summary, :targets_scope) %>
      <% highlights = @report_data.dig(:executive_summary, :high_level_findings) %>

      <% if overview.present? %>
        <p style="font-size: 15px; color: #4b566b; line-height: 1.6; margin-bottom: 15px;text-align: left;"><strong>Overview:</strong> <%= overview %></p>
      <% end %>

      <% if targets.present? %>
        <p style="font-size: 15px; color: #4b566b; line-height: 1.6; margin-bottom: 15px;text-align: left;"><strong>Scope:</strong> <%= targets %></p>
      <% end %>

      <!-- Metric Boxes -->
      <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
        <% if highlights.present? %>
          <% subdomains = highlights[/discovered (\d+) subdomains/, 1] %>
          <% assets = highlights[/identified (\d+) exposed assets/, 1] %>
          <% leaks = highlights[/uncovered (\d+) leaked credential sets/, 1] %>

          <% if subdomains %>
            <div style="flex: 1; min-width: 150px; background-color: #2e3e5c; padding: 15px; border-radius: 8px; text-align: left;">
              <p style="margin: 0; color: #9ecfff; font-size: 14px;">Subdomains</p>
              <p style="margin: 5px 0 0; font-size: 22px; font-weight: bold; color: #ffffff;"><%= subdomains %></p>
            </div>
          <% end %>

          <% if assets %>
            <div style="flex: 1; min-width: 150px; background-color: #2e3e5c; padding: 15px; border-radius: 8px; text-align: left;">
              <p style="margin: 0; color: #ffdf9e; font-size: 14px;">Exposed Assets</p>
              <p style="margin: 5px 0 0; font-size: 22px; font-weight: bold; color: #ffffff;"><%= assets %></p>
            </div>
          <% end %>

          <% if leaks %>
            <div style="flex: 1; min-width: 150px; background-color: #2e3e5c; padding: 15px; border-radius: 8px; text-align: left;">
              <p style="margin: 0; color: #ff9e9e; font-size: 14px;">Leaked Credentials</p>
              <p style="margin: 5px 0 0; font-size: 22px; font-weight: bold; color: #ffffff;"><%= leaks %></p>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>


    <!-- Methodology Section -->
    <div style="page-break-before: always;"></div>
    <% methodology = @report_data[:methodology] || [] %>

    <% task_categories = {
      "DNS Record Enumeration" => "Domain & DNS Intelligence",
      "WHOIS Enumeration" => "Domain & DNS Intelligence",
      "ASN Enumeration" => "Network & Infrastructure",
      "Subdomain Enumeration" => "Discovery",
      "Certificate Fetching" => "Discovery",
      "Shared Hosting Check" => "Network & Infrastructure",
      "Assets Search" => "Exposed Assets",
      "Logstealers Search" => "Leak Detection",
      "Search Leaks" => "Leak Detection",
      "Combo Search" => "Leak Detection",
      "Fetch Organization Info" => "Employee Informations",
      "Employees Search" => "Employee Informations",
      "File Scraper" => "Discovery",
      "Process Found Files" => "Analysis & Processing"
    } %>

    <% critical_tasks = ["Logstealers Search", "Search Leaks", "Process Found Files", "Assets Search"] %>

    <% if methodology.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px;text-align: center;">Methodology</h3>

        <% grouped = methodology.group_by { |task| task_categories[task[:task]] || "Other" } %>

        <% grouped.each do |category, tasks| %>
          <div style="margin-bottom: 25px;">
            <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 10px; border-bottom: 1px solid #3c5fc3; padding-bottom: 4px;">
              <%= category %>
            </h4>
            <div style="margin-top: 10px;">
              <% tasks.each do |task| %>
                <% is_critical = critical_tasks.include?(task[:task]) %>
                <div style="margin-bottom: 15px; padding: 10px; border-left: 4px solid '3c5fc3'; border-radius: 5px;">
                  <strong style="color: <%= is_critical ? '#ff9e9e' : '#5c7598' %>;">
                    <%= task[:task] %> <%= "(CRITICAL)" if is_critical %>
                  </strong><br>
                  <span style="font-size: 13px; color: #aaaaaa;">Status: <%= task[:status] %></span><br>
                  <span style="font-size: 14px;color: #5c7598;"><%= task[:description] %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>


    <!-- Findings Section -->

    <div style="page-break-before: always;"></div>
    <% dns_info = @report_data.dig(:findings, :domain_dns_intelligence) || {} %>
    <% dns_summary = dns_info[:dns_records_summary] || {} %>
    <% whois = dns_info[:whois_info_shown] || [] %>

    <% if dns_info.present? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px;text-align: center;">Domain & DNS Intelligence</h3>

        <!-- Domain Info -->
        <div style="margin-bottom: 25px;">
          <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 10px;">Domains</h4>
          <p style="font-size: 14px; color: #5c7598;">
            <strong>Total Domains Identified:</strong> <%= dns_info[:domains] || 0 %>
          </p>
        </div>

        <!-- DNS Info -->
        <div style="margin-bottom: 25px;">
          <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 10px;">DNS Records</h4>

          <!-- NS Records -->
          <% if dns_summary[:ns_records_info].present? %>
            <h5 style="font-size: 14px; color: #a4a4a4; margin-bottom: 5px;">NS Records</h5>
            <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #ccd0d6;">
                  <th align="left" style="padding: 6px;">Name</th>
                  <th align="left" style="padding: 6px;">IP</th>
                </tr>
              </thead>
              <tbody>
                <% dns_summary[:ns_records_info].each do |rec| %>
                  <tr>
                    <td style="padding: 6px;"><%= rec[:name] %></td>
                    <td style="padding: 6px;"><%= rec[:ip] %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% if dns_summary[:ns_note] %>
              <p style="font-size: 13px; color: #aaaaaa; margin-top: 5px;"><%= dns_summary[:ns_note] %></p>
            <% end %>
          <% end %>

          <!-- MX Records -->
          <% if dns_summary[:mx_records_info].present? %>
            <h5 style="font-size: 14px; color: #a4a4a4; margin: 25px 0 5px;">MX Records</h5>
            <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #ccd0d6;">
                  <th align="left" style="padding: 6px;">Name</th>
                  <th align="left" style="padding: 6px;">IP</th>
                </tr>
              </thead>
              <tbody>
                <% dns_summary[:mx_records_info].each do |rec| %>
                  <tr>
                    <td style="padding: 6px;"><%= rec[:name] %></td>
                    <td style="padding: 6px;"><%= rec[:ip] %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% if dns_summary[:mx_note] %>
              <p style="font-size: 13px; color: #aaaaaa; margin-top: 5px;"><%= dns_summary[:mx_note] %></p>
            <% end %>
          <% end %>
        </div>

        <!-- WHOIS Info -->
        <% if whois.any? %>
          <div>
            <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 10px;">WHOIS Records</h4>
            <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #ccd0d6;">
                  <th align="left" style="padding: 6px;">Domain</th>
                  <th align="left" style="padding: 6px;">Registrar</th>
                  <th align="left" style="padding: 6px;">Created</th>
                  <th align="left" style="padding: 6px;">Updated</th>
                  <th align="left" style="padding: 6px;">Expires</th>
                </tr>
              </thead>
              <tbody>
                <% whois.each do |w| %>
                  <% next if [w[:domain_name], w[:registrar], w[:creation_date], w[:updated_date], w[:expiration_date]].all?(&:blank?) %>
                  <tr>
                    <td style="padding: 6px;"><%= w[:domain_name] || "N/A" %></td>
                    <td style="padding: 6px;"><%= w[:registrar] || "N/A" %></td>
                    <td style="padding: 6px;"><%= w[:creation_date] || "N/A" %></td>
                    <td style="padding: 6px;"><%= w[:updated_date] || "N/A" %></td>
                    <td style="padding: 6px;"><%= w[:expiration_date] || "N/A" %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <% if dns_info[:whois_note] %>
              <p style="font-size: 13px; color: #aaaaaa; margin-top: 5px;"><%= dns_info[:whois_note] %></p>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% network = @report_data.dig(:findings, :network_infrastructure) || {} %>
    <% shared_summary = network[:shared_hosting_summary] || {} %>
    <% shared_hosts = shared_summary[:hosts] || [] %>

    <% if network[:asn_count].to_i > 0 || shared_hosts.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px;text-align: center;">Network Infrastructure</h3>

        <!-- ASN Count -->
        <% if network[:asn_count].to_i > 0 %>
          <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 8px;">AS Number Overview</h4>
          <p style="font-size: 14px; color: #5c7598;">
            <strong>Total ASNs Identified:</strong> <%= network[:asn_count] %>
          </p>
        <% end %>

        <!-- Shared Hosting Exposure -->
        <% if shared_hosts.any? %>
          <h4 style="font-size: 16px; color: #121e2b; margin-top: 25px; margin-bottom: 10px;">Shared Hosting Exposure</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 6px;">Domain</th>
                <th align="left" style="padding: 6px;">Shared With</th>
              </tr>
            </thead>
            <tbody>
              <% shared_hosts.each do |host| %>
                <% next if host[:domain].blank? && (host[:shared_with] || []).compact.empty? %>
                <tr>
                  <td style="padding: 6px;"><%= host[:domain] %></td>
                  <td style="padding: 6px;">
                    <ul style="margin: 0; padding-left: 0; list-style-type: none;">
                      <% host[:shared_with].each do |shared| %>
                        <li><%= shared %></li>
                      <% end %>
                      <% if host[:shared_with_truncated] %>
                        <li style="color: #aaaaaa;"><em>(truncated)</em></li>
                      <% end %>
                    </ul>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>

          <% if shared_summary[:note].present? %>
            <p style="font-size: 13px; color: #aaaaaa;"><%= shared_summary[:note] %></p>
          <% end %>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% subdomains = @report_data.dig(:findings, :subdomain_enumeration) || {} %>
    <% shown = subdomains[:shown] || [] %>

    <% if subdomains[:total_found].to_i > 0 %>
      <div style="margin: 40px 0;padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center;">Subdomain Enumeration</h3>

        <!-- Description -->
        <p style="font-size: 14px; color: #4b566b; margin-bottom: 15px;">
          This section highlights a sample of the subdomains identified during the reconnaissance process. The full list — along with associated technologies, open ports, and vulnerabilities — is available in the Oktoboot dashboard for deeper investigation and remediation.
        </p>

        <!-- Total Count -->
        <p style="font-size: 14px; color: #4b566b; margin-bottom: 10px;">
          <strong>Total Unique Subdomains Found:</strong> <%= subdomains[:total_found] %>
        </p>

        <!-- Grouped Table -->
        <% grouped = shown.group_by { |s| s.split('.').last(2).join('.') } %>
        <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #ccd0d6;">
              <th align="left" style="padding: 6px;">Root Domain</th>
              <th align="left" style="padding: 6px;">Subdomain</th>
            </tr>
          </thead>
          <tbody>
            <% grouped.each do |root, subs| %>
              <% subs.each_with_index do |sd, index| %>
                <% style = case sd
                  when /admin|login|secure/i then 'color: #ff7b7b; font-weight: 600;'
                  when /dev|test|staging/i then 'color: #73c2fb; font-weight: 600;'
                  when /internal|private|backup/i then 'color: #ffc078; font-weight: 600;'
                  else ''
                end %>
                <tr>
                  <td style="padding: 6px;"><%= index.zero? ? root : "" %></td>
                  <td style="padding: 6px; <%= style %>"><%= sd %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>

        <% if subdomains[:note].present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;"><%= subdomains[:note] %></p>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% certs = @report_data.dig(:findings, :certificate_https, :certificates) || [] %>
    <% if certs.any? %>
      <% now = Time.now.utc %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center;">Certificate HTTPS Enumeration</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 15px;">
          This section summarizes digital certificates discovered during reconnaissance. Certificates may reveal subdomains or exposure timelines. Review carefully — and check Oktoboot Dashboard for full details.
        </p>
        <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #ccd0d6;">
              <th align="left" style="padding: 6px;">Common Name</th>
              <th align="left" style="padding: 6px;">Valid From</th>
              <th align="left" style="padding: 6px;">Valid To</th>
            </tr>
          </thead>
          <tbody>
            <% certs.each do |cert| %>
              <% begin %>
                <% valid_to = cert[:valid_to].present? ? Time.parse(cert[:valid_to]) : nil %>
              <% rescue %>
                <% valid_to = nil %>
              <% end %>

              <% is_expired = valid_to.present? && valid_to < now %>
              <tr>
                <td style="padding: 6px;"><%= cert[:common_name].presence || "N/A" %></td>
                <td style="padding: 6px;"><%= cert[:valid_from].presence || "N/A" %></td>
                <td style="padding: 6px; <%= is_expired ? 'color: #ff7b7b; font-weight: 600;' : '' %>">
                  <%= cert[:valid_to].presence || "N/A" %>
                  <% if is_expired %><span style="color: #ff7b7b;"> (expired)</span><% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <% if certs.size == 5 %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;">
            Only the first 5 certificates are shown. View the Oktoboot dashboard for the full list.
          </p>
        <% end %>
      </div>
    <% end %>


    
    <div style="page-break-before: always;"></div>
    <% assets = @report_data.dig(:findings, :exposed_assets, :shown) || [] %>
    <% if assets.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center">Exposed Assets Overview</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
          These exposed assets may pose risk due to open ports, outdated services, or certificate leaks. Risk levels and recommendations are based on observed configurations and known vulnerabilities.
        </p>

        <% assets.each do |asset| %>
            <!-- Asset Title -->
            <h4 style="color: #9ecfff; font-size: 18px; font-weight: 700; margin-bottom: 10px;"><%= asset[:ip] %></h4>

            <!-- Inline Metadata -->
            <div style="font-size: 14px; color: #4b566b; margin-bottom: 12px;">
              <strong>Domain:</strong> <%= asset[:domain].presence || "N/A" %> &nbsp;|&nbsp;
              <strong>ISP:</strong> <%= asset[:isp].presence || "N/A" %> &nbsp;|&nbsp;
              <strong>Risk:</strong> 
              <span style="<%= case asset[:risk_level]
                              when "High" then 'color: #ff7b7b; font-weight: 600;'
                              when "Medium" then 'color: #ffc078; font-weight: 600;'
                              when "Low" then 'color: #73c2fb; font-weight: 600;'
                              else ''
                            end %>">
                <%= asset[:risk_level] %>
              </span>
            </div>

            <!-- Open Ports -->
            <% if asset[:open_ports].present? %>
              <h5 style="font-size: 15px; color: #4b566b; font-weight: 600; margin-top: 20px;">Open Ports</h5>
              <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px;">
                <thead>
                  <tr style="background-color: #ccd0d6;">
                    <th align="left" style="padding: 8px;">Port</th>
                    <th align="left" style="padding: 8px;">Module</th>
                    <th align="left" style="padding: 8px;">Version</th>
                    <th align="left" style="padding: 8px;">SSL</th>
                  </tr>
                </thead>
                <tbody>
                  <% asset[:open_ports].each do |port| %>
                    <tr>
                      <td style="padding: 6px;"><%= port[:port] %></td>
                      <td style="padding: 6px;"><%= port[:module] %></td>
                      <td style="padding: 6px;"><%= port[:version].presence || "N/A" %></td>
                      <td style="padding: 6px;">
                        <% if port[:ssl].present? %>
                          <% port[:ssl].each do |ssl| %>
                            <div style="margin-bottom: 3px;">
                              <strong><%= ssl[:common_name] %></strong><br>
                              <span style="font-size: 12px; color: #bbbbbb;"><%= ssl[:issuer] %> | <%= ssl[:versions] %></span>
                            </div>
                          <% end %>
                        <% else %>
                          N/A
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% end %>

            <!-- Top Vulnerabilities -->
            <% if asset[:vulnerabilities].present? %>
              <h5 style="font-size: 15px; color: #4b566b; font-weight: 600; margin-top: 25px;">Top Vulnerabilities</h5>
              <% asset[:vulnerabilities].first(5).each do |vuln| %>
                <div style="margin-bottom: 18px;">
                  <div style="font-size: 14px; font-weight: bold; color: #73c2fb; margin-bottom: 3px;">
                    <%= vuln[:title] %>
                  </div>
                  <div style="font-size: 13px; color: 
                    <%= case vuln[:severity]
                          when 'Critical' then '#c0392b' 
                          when 'High' then '#ff7b7b'
                          when 'Medium' then '#ffc078'
                          else '#bbbbbb'
                      end %>;">
                    <%= vuln[:severity] %> severity — CVSS: <%= vuln[:cvss] %>
                  </div>
                  <div style="font-size: 13px; color: #4b566b; margin-top: 4px;">
                    <%= vuln[:description] %>
                  </div>
                </div>
              <% end %>

              <% if asset[:vulnerabilities].size > 5 %>
                <p style="font-size: 12px; color: #aaaaaa;"><em>Only the first 5 vulnerabilities are shown. See dashboard for more.</em></p>
              <% end %>
            <% end %>

            <!-- Recommendation -->
            <% if asset[:recommendation].present? %>
              <p style="margin-top: 25px; font-size: 14px; color: #4b566b; font-weight: 600;">Recommended Mitigation</p>
              <p style="font-size: 13px; color: #4b566b; margin-top: 5px;"><%= asset[:recommendation] %></p>
            <% end %>
        <% end %>

        <% if @report_data.dig(:findings, :exposed_assets, :note).present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;"><%= @report_data.dig(:findings, :exposed_assets, :note) %></p>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% leaks = @report_data.dig(:findings, :data_leaks_and_breaches) || {} %>
    <% if leaks[:logstealer_leaks][:total].to_i > 0 || leaks[:public_leaks][:total].to_i > 0 || leaks[:combo_leaks][:total].to_i > 0 %>
      <div style="margin: 40px 0;padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px;text-align: center;">Data Leaks & Credential Exposure</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 15px;">
          These exposed credentials were found across malware logs, public breaches, and combo lists. They may be linked to user accounts or internal access points. Please investigate and rotate impacted credentials immediately. Full dump available in the Oktoboot dashboard.
        </p>

        <!-- Logstealer Leaks -->
        <% if leaks[:logstealer_leaks][:shown].present? %>
          <h4 style="font-size: 16px; color: #4b566b; margin-top: 25px;">Logstealer Leaks</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 6px;">URL</th>
                <th align="left" style="padding: 6px;">Email</th>
                <th align="left" style="padding: 6px;">Password</th>
                <th align="left" style="padding: 6px;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:logstealer_leaks][:shown].each do |entry| %>
                <tr>
                  <td style="padding: 6px; word-break: break-word;"><%= entry[2] %></td>
                  <td style="padding: 6px;"><%= entry[0] %></td>
                  <td style="padding: 6px;"><%= entry[1] %></td>
                  <td style="padding: 6px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <% if leaks[:logstealer_leaks][:note].present? %>
            <p style="font-size: 13px; color: #aaaaaa; margin-top: 8px;"><%= leaks[:logstealer_leaks][:note] %></p>
          <% end %>
        <% end %>

        <div style="page-break-before: always;"></div>
        <!-- Public Breach Leaks -->
        <% if leaks[:public_leaks][:shown].present? %>
          <h4 style="font-size: 16px; color: #4b566b; margin-top: 30px;">Public Breach Leaks</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 6px;">Leak Source</th>
                <th align="left" style="padding: 6px;">Email</th>
                <th align="left" style="padding: 6px;">Password</th>
                <th align="left" style="padding: 6px;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:public_leaks][:shown].each do |entry| %>
                <tr>
                  <td style="padding: 6px;"><%= entry[2] %></td>
                  <td style="padding: 6px;"><%= entry[0] %></td>
                  <td style="padding: 6px;"><%= entry[1] %></td>
                  <td style="padding: 6px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <% if leaks[:public_leaks][:note].present? %>
            <p style="font-size: 13px; color: #aaaaaa; margin-top: 8px;"><%= leaks[:public_leaks][:note] %></p>
          <% end %>
        <% end %>

        <div style="page-break-before: always;"></div>
        <!-- Combo List Leaks -->
        <% if leaks[:combo_leaks][:shown].present? %>
          <h4 style="font-size: 16px; color: #4b566b; margin-top: 30px;">Combo List Leaks</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 6px;">Domain</th>
                <th align="left" style="padding: 6px;">Email</th>
                <th align="left" style="padding: 6px;">Password</th>
                <th align="left" style="padding: 6px;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:combo_leaks][:shown].each do |entry| %>
                <tr>
                  <td style="padding: 6px;"><%= entry[2] %></td>
                  <td style="padding: 6px;"><%= entry[0] %></td>
                  <td style="padding: 6px;"><%= entry[1] %></td>
                  <td style="padding: 6px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <% if leaks[:combo_leaks][:note].present? %>
            <p style="font-size: 13px; color: #aaaaaa; margin-top: 8px;"><%= leaks[:combo_leaks][:note] %></p>
          <% end %>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% employees = @report_data.dig(:findings, :employee_information) || {} %>
    <% shown = employees[:shown] || [] %>

    <% if employees[:total_found].to_i > 0 %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px;text-align: center;">Employee Enumeration</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 12px;">
          This section lists publicly accessible employees discovered during reconnaissance. Full role breakdowns and exposure context are available in the Oktoboot dashboard.
        </p>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
          <strong>Total Identified:</strong> <%= employees[:total_found] %>
        </p>

        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
          <% shown.each do |emp| %>
            <div style="flex: 1 1 45%; background-color: #1a273b; padding: 12px 16px; border-radius: 6px;">
              <p style="margin: 0; font-size: 14px; font-weight: 600; color: #ffffff;"><%= emp[:fullname] %></p>
              <p style="margin-top: 4px; font-size: 13px; color: #cccccc;"><%= emp[:poste].presence || "N/A" %></p>
            </div>
          <% end %>
        </div>

        <% if employees[:note].present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 20px;"><%= employees[:note] %></p>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% meta = @report_data.dig(:findings, :metadata_public_files) || {} %>
    <% files = meta[:files] || [] %>
    <% sensitive = meta[:sensitive_data] || [] %>

    <% if files.any? || sensitive.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px; text-align: center;">Metadata & Public Files</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 16px;">
          This section lists publicly accessible files and detected metadata exposures. View complete data in your Oktoboot dashboard.
        </p>

        <% if files.any? %>
          <h4 style="font-size: 16px; color: #4b566b; font-weight: 600; margin-bottom: 10px;">Discovered Files</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 8px;">File Name</th>
                <th align="left" style="padding: 8px;">URL</th>
              </tr>
            </thead>
            <tbody>
              <% files.each do |file| %>
                <tr style="border-bottom: 1px solid #333;">
                  <td style="padding: 6px; vertical-align: top;"><%= file[:name].presence || "N/A" %></td>
                  <td style="padding: 6px; vertical-align: top;">
                    <% if file[:url].present? %>
                      <a href="<%= file[:url] %>" target="_blank" style="color: #4fb7ff; word-break: break-word; text-decoration: underline;">
                        <%= file[:url] %>
                      </a>
                    <% else %>
                      N/A
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% risks = @report_data[:risk_assessment] || {} %>
    <% high_risks = risks[:high_risks] || [] %>
    <% medium_risks = risks[:medium_risks] || [] %>
    <% info_risks = risks[:info_risks] || [] %>

    <% if high_risks.any? || medium_risks.any? || info_risks.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px; text-align: center;">Risk Assessment</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
          The following risks were identified during the reconnaissance phase. They are categorized by severity and may require immediate remediation or strategic consideration.
        </p>

        <% if high_risks.any? %>
          <h4 style="font-size: 16px; color: #ff6b6b; font-weight: 600; margin-top: 20px;">High Risks</h4>
          <% high_risks.each do |risk| %>
            <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
              <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
            </div>
          <% end %>
        <% end %>

        <% if medium_risks.any? %>
          <h4 style="font-size: 16px; color: #f7c948; font-weight: 600; margin-top: 30px;">Medium Risks</h4>
          <% medium_risks.each do |risk| %>
            <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
              <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
            </div>
          <% end %>
        <% end %>

        <% if info_risks.any? %>
          <h4 style="font-size: 16px; color: #9ecfff; font-weight: 600; margin-top: 30px;">Informational</h4>
          <% info_risks.each do |risk| %>
            <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
              <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>



    <div style="page-break-before: always;"></div>
    <% recommendations = @report_data[:recommendations] || {} %>
    <% if recommendations.values.flatten.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px; text-align: center;">
          Recommendations
        </h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 16px;">
          Prioritized guidance based on reconnaissance findings. Grouped by severity for operational clarity.
        </p>

        <% {
          "Critical" => [recommendations[:critical], "#ff4c4c"],
          "Important" => [recommendations[:important], "#f7c948"],
          "Best Practice" => [recommendations[:best_practice], "#4fb7ff"]
        }.each do |severity, (items, color)| %>
          <% if items.any? %>
            <h4 style="font-size: 16px; color: <%= color %>; font-weight: 600; margin-top: 30px;">
              <%= severity %> Recommendations
            </h4>

            <% items.each do |rec| %>
              <div style="margin-bottom: 18px; padding: 12px; border-left: 4px solid <%= color %>; border-radius: 4px;">
                <p style="margin: 0; font-size: 14px; color: <%= color %>;">
                  <strong>Area:</strong> <%= rec[:area] %>
                </p>
                <p style="margin: 6px 0 0; font-size: 14px; color: #5c7598;">
                  <%= rec[:recommendation] %>
                </p>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% end %>



  </div>
</body>
</html>
