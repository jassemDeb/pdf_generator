<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @report_data[:title] || "Threat Intelligence Report" %></title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
    
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #121e2b;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #00adee;
    }
    
    .logo {
      max-width: 180px;
      margin-bottom: 15px;
    }
    
    h1, h2, h3, h4 {
      color: #121e2b;
      margin-top: 0;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
    }
    
    h2 {
      font-size: 20px;
      font-weight: 600;
      margin-top: 30px;
      border-bottom: 1px solid #eaeaea;
      padding-bottom: 10px;
      color: #2a4caa;
    }
    
    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 25px;
      color: #00adee;
    }
    
    p {
      margin-bottom: 15px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    th, td {
      padding: 12px 15px;
      border: 1px solid #ddd;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      text-align: left;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    .section {
      margin-bottom: 40px;
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .chart-container {
      margin: 20px 0;
      height: 300px;
    }
    
    .findings-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eaeaea;
    }
    
    .findings-item:last-child {
      border-bottom: none;
    }
    
    .page-break {
      page-break-before: always;
    }
    
    .risk-high {
      color: #d9534f;
    }
    
    .risk-medium {
      color: #f0ad4e;
    }
    
    .risk-low {
      color: #5bc0de;
    }
    
    .blue-header {
      background-color: #2a4caa;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    ul {
      padding-left: 20px;
    }
    
    ul li {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Report Header -->
    <div class="header">
      <% if @logo_data %>
        <img src="data:image/png;base64,<%= @logo_data %>" alt="Company Logo" class="logo">
      <% else %>
        <div style="text-align: center; border: 1px dashed #ccc; padding: 10px; margin-bottom: 15px;">
          <span style="color: #888;">Company Logo</span>
        </div>
      <% end %>
      <h1><%= @report_data[:title] || "Threat Intelligence Report" %></h1>
      <p style="text-align: center; font-size: 18px;">
        <strong><%= @report_data.dig(:executive_summary, :targets_scope) || "Unspecified Domain" %></strong>
      </p>
      <p style="text-align: center; font-size: 14px;">
        <strong>Created At:</strong> <%= @report_data[:created_at]&.strftime("%B %d, %Y at %H:%M") || "N/A" %><br>
        <strong>Updated At:</strong> <%= @report_data[:updated_at]&.strftime("%B %d, %Y at %H:%M") || "N/A" %>
      </p>
    </div>

    <!-- Report Metadata -->
    <div class="section">
      <h2>Report Metadata</h2>
      <table>
        <tr>
          <td><strong>Version:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :report_version) || "N/A" %></td>
        </tr>
        <tr>
          <td><strong>Generated By:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :generated_by) || "N/A" %></td>
        </tr>
        <tr>
          <td><strong>Generated At:</strong></td>
          <td><%= @report_data.dig(:report_metadata, :generated_at) || "N/A" %></td>
        </tr>
      </table>
    </div>

    <!-- Executive Summary -->
    <div class="section">
      <h2>Executive Summary</h2>
      <% if summary = @report_data.dig(:executive_summary, :summary) %>
        <%= raw summary %>
      <% else %>
        <p>No executive summary provided.</p>
      <% end %>
      
      <h3>Overview:</h3>
      <p><%= @report_data.dig(:executive_summary, :overview) || "No overview provided." %></p>
      
      <h3>Scope:</h3>
      <p><%= @report_data.dig(:executive_summary, :targets) || "No targets specified." %></p>
    </div>

    <!-- Subdomains Section -->
    <div class="section">
      <h2 class="blue-header">Subdomains</h2>
      <% if @report_data[:subdomains].present? %>
        <ul>
          <% @report_data[:subdomains].each do |subdomain| %>
            <li><%= subdomain %></li>
          <% end %>
        </ul>
      <% else %>
        <p>No subdomains discovered.</p>
      <% end %>
    </div>

    <!-- Exposed Assets Section -->
    <div class="section">
      <h2 class="blue-header">Exposed Assets</h2>
      <% if @report_data[:assets].present? %>
        <ul>
          <% @report_data[:assets].each do |asset| %>
            <li><%= asset %></li>
          <% end %>
        </ul>
      <% else %>
        <p>No exposed assets discovered.</p>
      <% end %>
    </div>

    <!-- Leaked Credentials Section -->
    <div class="section">
      <h2 class="blue-header">Leaked Credentials</h2>
      <% if @report_data[:leaks].present? %>
        <ul>
          <% @report_data[:leaks].each do |leak| %>
            <li><%= leak %></li>
          <% end %>
        </ul>
      <% else %>
        <p>No leaked credentials discovered.</p>
      <% end %>
    </div>

    <% 
      # Sample data for the report sections
      vulnerabilities = [
        { name: "CVE-2023-1234", description: "Critical SQL Injection vulnerability in login form", severity: "High", cvss: 9.8 },
        { name: "CVE-2023-5678", description: "Cross-Site Scripting (XSS) in comment section", severity: "Medium", cvss: 6.5 },
        { name: "CVE-2023-9012", description: "Information disclosure in error messages", severity: "Low", cvss: 3.2 }
      ]
      
      network_info = {
        domains: ["example.com", "example-staging.com", "example-dev.com"],
        ip_ranges: ["192.168.1.0/24", "10.0.0.0/16"],
        open_ports: [
          { ip: "192.168.1.10", port: 80, service: "HTTP" },
          { ip: "192.168.1.10", port: 443, service: "HTTPS" },
          { ip: "192.168.1.20", port: 22, service: "SSH" }
        ]
      }
      
      leaks = [
        { source: "GitHub", date: "2023-01-15", type: "API Keys", severity: "High" },
        { source: "Pastebin", date: "2023-02-20", type: "Customer Data", severity: "Critical" }
      ]
      
      employees = [
        { email: "john.doe@example.com", breaches: 3, last_breach: "2022-11-10" },
        { email: "jane.smith@example.com", breaches: 1, last_breach: "2023-01-05" }
      ]
      
      high_risks = [
        { name: "Exposed Admin Interface", description: "The admin interface is accessible from the internet without proper authentication", mitigation: "Implement IP restrictions and strong authentication" },
        { name: "Outdated Software", description: "Several critical services are running outdated versions with known vulnerabilities", mitigation: "Implement a regular patching schedule" }
      ]
      
      medium_risks = [
        { name: "Weak Password Policy", description: "Current password policy does not enforce sufficient complexity", mitigation: "Update password policy to require longer passwords with special characters" },
        { name: "Insecure Cookies", description: "Session cookies are not using secure and httpOnly flags", mitigation: "Configure all cookies with secure and httpOnly flags" }
      ]
      
      low_risks = [
        { name: "Missing Security Headers", description: "Several recommended security headers are not implemented", mitigation: "Add Content-Security-Policy and other security headers" }
      ]
    %>

    <% if vulnerabilities.any? %>
      <div class="section">
        <h2 class="blue-header">Vulnerabilities</h2>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Description</th>
              <th>Severity</th>
              <th>CVSS</th>
            </tr>
          </thead>
          <tbody>
            <% vulnerabilities.each do |vuln| %>
              <tr>
                <td><%= vuln[:name] %></td>
                <td><%= vuln[:description] %></td>
                <td>
                  <% if vuln[:severity] == "High" %>
                    <span class="risk-high"><%= vuln[:severity] %></span>
                  <% elsif vuln[:severity] == "Medium" %>
                    <span class="risk-medium"><%= vuln[:severity] %></span>
                  <% else %>
                    <span class="risk-low"><%= vuln[:severity] %></span>
                  <% end %>
                </td>
                <td><%= vuln[:cvss] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <% if network_info.present? %>
      <div class="section">
        <h2 class="blue-header">Network Intelligence</h2>
        
        <div class="row">
          <div class="col-md-6">
            <h3>Domains</h3>
            <ul>
              <% network_info[:domains].each do |domain| %>
                <li><%= domain %></li>
              <% end %>
            </ul>
          </div>
          
          <div class="col-md-6">
            <h3>IP Ranges</h3>
            <ul>
              <% network_info[:ip_ranges].each do |range| %>
                <li><%= range %></li>
              <% end %>
            </ul>
          </div>
        </div>
        
        <h3>Open Ports</h3>
        <table>
          <thead>
            <tr>
              <th>IP Address</th>
              <th>Port</th>
              <th>Service</th>
            </tr>
          </thead>
          <tbody>
            <% network_info[:open_ports].each do |port| %>
              <tr>
                <td><%= port[:ip] %></td>
                <td><%= port[:port] %></td>
                <td><%= port[:service] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <% if leaks.present? || employees.present? %>
      <div class="section">
        <h2 class="blue-header">Data Leaks and Breaches</h2>
        
        <% if leaks.present? %>
          <h3>Identified Data Leaks</h3>
          <table>
            <thead>
              <tr>
                <th>Source</th>
                <th>Date</th>
                <th>Type</th>
                <th>Severity</th>
              </tr>
            </thead>
            <tbody>
              <% leaks.each do |leak| %>
                <tr>
                  <td><%= leak[:source] %></td>
                  <td><%= leak[:date] %></td>
                  <td><%= leak[:type] %></td>
                  <td>
                    <% if leak[:severity] == "Critical" || leak[:severity] == "High" %>
                      <span class="risk-high"><%= leak[:severity] %></span>
                    <% elsif leak[:severity] == "Medium" %>
                      <span class="risk-medium"><%= leak[:severity] %></span>
                    <% else %>
                      <span class="risk-low"><%= leak[:severity] %></span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
        
        <% if employees.present? %>
          <h3>Compromised Employee Accounts</h3>
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Breaches</th>
                <th>Last Breach</th>
              </tr>
            </thead>
            <tbody>
              <% employees.each do |employee| %>
                <tr>
                  <td><%= employee[:email] %></td>
                  <td><%= employee[:breaches] %></td>
                  <td><%= employee[:last_breach] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    <% end %>

    <% if high_risks.any? || medium_risks.any? || low_risks.any? %>
      <div class="section">
        <h2 class="blue-header">Risk Assessment</h2>
        
        <div class="chart-container">
          <!-- Risk distribution chart would go here in a real implementation -->
          <div style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
            <p style="margin: 0; color: #666;">
              Risk Distribution: 
              <span class="risk-high">High (<%= high_risks.size %>)</span> | 
              <span class="risk-medium">Medium (<%= medium_risks.size %>)</span> | 
              <span class="risk-low">Low (<%= low_risks.size %>)</span>
            </p>
          </div>
        </div>
        
        <% if high_risks.any? %>
          <h3>High Risks</h3>
          <% high_risks.each do |risk| %>
            <div class="findings-item">
              <h4 class="risk-high"><%= risk[:name] %></h4>
              <p><strong>Description:</strong> <%= risk[:description] %></p>
              <p><strong>Recommended Mitigation:</strong> <%= risk[:mitigation] %></p>
            </div>
          <% end %>
        <% end %>
        
        <% if medium_risks.any? %>
          <h3>Medium Risks</h3>
          <% medium_risks.each do |risk| %>
            <div class="findings-item">
              <h4 class="risk-medium"><%= risk[:name] %></h4>
              <p><strong>Description:</strong> <%= risk[:description] %></p>
              <p><strong>Recommended Mitigation:</strong> <%= risk[:mitigation] %></p>
            </div>
          <% end %>
        <% end %>
        
        <% if low_risks.any? %>
          <h3>Low Risks</h3>
          <% low_risks.each do |risk| %>
            <div class="findings-item">
              <h4 class="risk-low"><%= risk[:name] %></h4>
              <p><strong>Description:</strong> <%= risk[:description] %></p>
              <p><strong>Recommended Mitigation:</strong> <%= risk[:mitigation] %></p>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</body>
</html>
